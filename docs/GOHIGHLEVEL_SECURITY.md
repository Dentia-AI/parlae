# GoHighLevel Integration - Security Guide

This document outlines security best practices for the GHL integration.

---

## üîê Credential Security

### Files Containing Actual Credentials

These files contain real credentials and **MUST NEVER** be committed to git:

| File | Contains | Ignored by Git? |
|------|----------|----------------|
| `.env.ghl` | All GHL credentials | ‚úÖ Yes |
| `.env.ghl.sh` | Shell export script | ‚úÖ Yes |
| `apps/frontend/.env.local` | All env vars including GHL | ‚úÖ Yes |

### Safe Files (Can Be Committed)

These files contain only placeholders/examples:

| File | Purpose | Safe to Commit? |
|------|---------|----------------|
| `.env.ghl.example` | Template with placeholders | ‚úÖ Yes |
| `apps/frontend/.env.local.example` | Template with placeholders | ‚úÖ Yes |

---

## üö´ What Should NEVER Be Committed

### ‚ùå Never Commit These

```bash
# Bad - contains actual credentials
.env.ghl
.env.ghl.sh
.env.local
.env

# Any file with actual API keys
GHL_API_KEY=pit-8a1eae7c-9011-479c-ab50-274754b3ae0b
```

### ‚úÖ Safe to Commit These

```bash
# Good - contains only placeholders
.env.ghl.example
.env.local.example

# Example content
GHL_API_KEY=your-api-key-here
```

---

## üîç Pre-Commit Checklist

Before committing, always run:

```bash
# 1. Check what's staged
git status

# 2. Review changes
git diff --cached

# 3. Look for credentials
git diff --cached | grep -i "api.*key\|secret\|password\|token"

# 4. If you find credentials, unstage immediately
git reset HEAD path/to/file
```

---

## üõ°Ô∏è Security Layers

### Layer 1: .gitignore

Your `.gitignore` includes:

```gitignore
# Environment variables
.env
.env.local
.env.*.local

# GoHighLevel credentials (generated by setup-ghl.sh)
.env.ghl
.env.ghl.sh
```

### Layer 2: Server-Side Only

API keys are server-side only:

```typescript
// ‚úÖ Good - server-only
import 'server-only';
const apiKey = process.env.GHL_API_KEY;
```

```typescript
// ‚ùå Bad - client-side
'use client';
const apiKey = process.env.GHL_API_KEY; // Never do this!
```

### Layer 3: Environment Variable Types

**Server-Side Only** (Never exposed to client):
- `GHL_API_KEY` - Full API access
- `GHL_LOCATION_ID` - Used in API calls

**Client-Side Safe** (Public facing, limited scope):
- `NEXT_PUBLIC_GHL_WIDGET_ID` - Only allows chat interaction
- `NEXT_PUBLIC_GHL_LOCATION_ID` - Used as widget attribute
- `NEXT_PUBLIC_GHL_CALENDAR_ID` - Only allows booking interaction

---

## üîí API Key Security

### Server-Side Usage

The API key is used in server-side code with `Authorization` header:

```typescript
// ‚úÖ Correct - server-side only
const response = await fetch('https://services.leadconnectorhq.com/contacts/upsert', {
  method: 'POST',
  headers: {
    'Authorization': `Bearer ${process.env.GHL_API_KEY}`, // Server-only
    'Content-Type': 'application/json',
  },
  body: JSON.stringify({
    locationId: process.env.GHL_LOCATION_ID, // Server-only
    email: 'user@example.com',
    // ...
  }),
});
```

### What the API Key Can Do

With `GHL_API_KEY`, someone can:
- ‚úÖ Create/update/delete contacts
- ‚úÖ Access all CRM data
- ‚úÖ Manage calendars
- ‚úÖ Send messages
- ‚úÖ Full account access

**This is why it must NEVER be exposed!**

### What Widget/Calendar IDs Can Do

With `NEXT_PUBLIC_GHL_WIDGET_ID` or `NEXT_PUBLIC_GHL_CALENDAR_ID`, someone can only:
- ‚úÖ Open your chat widget (same as visiting your site)
- ‚úÖ Book appointments in your calendar (same as using your booking page)
- ‚ùå Cannot access contacts
- ‚ùå Cannot access CRM data
- ‚ùå Cannot modify anything

**These are safe to expose publicly.**

---

## üö® If Credentials Are Leaked

### Immediate Actions

1. **Revoke the API Key in GHL**:
   - Log in to GoHighLevel
   - Go to Settings ‚Üí Company ‚Üí API Keys
   - Delete the compromised key
   - Generate a new one

2. **Remove from Git History** (if committed):
   ```bash
   # Use BFG Repo Cleaner or git-filter-repo
   # This is complex - consider rotating keys instead
   ```

3. **Update Credentials Everywhere**:
   - Local `.env.local`
   - AWS SSM Parameter Store
   - Any deployed environments
   - Team members' local environments

4. **Deploy New Credentials**:
   ```bash
   # Update SSM
   cd dentia-infra
   ./infra/scripts/put-ssm-secrets.sh
   
   # Deploy new task definition
   # (See deployment guide)
   ```

---

## üîê Best Practices

### 1. Credential Rotation

Rotate API keys regularly:

```bash
# Every 90 days
1. Generate new API key in GHL
2. Update local .env.local
3. Update SSM Parameter Store
4. Deploy new task definition
5. Verify functionality
6. Revoke old API key
```

### 2. Environment Separation

Use different credentials for different environments:

| Environment | API Key | Location |
|-------------|---------|----------|
| Local Dev | Development key | Dev location |
| Staging | Staging key | Staging location |
| Production | Production key | Production location |

### 3. Access Control

Limit who has access to production credentials:

```bash
# Only authorized team members should have:
- Access to production GHL account
- Access to AWS SSM Parameter Store
- Access to production .env files
```

### 4. Audit Logging

Monitor API key usage:

1. Check GHL API logs regularly
2. Set up CloudWatch alarms for unusual activity
3. Review access patterns monthly

---

## ‚úÖ Security Checklist

Before deploying:

- [ ] `.env.ghl` is in `.gitignore`
- [ ] `.env.ghl.sh` is in `.gitignore`
- [ ] `.env.local` is in `.gitignore`
- [ ] No credentials in git history
- [ ] API key is in AWS SSM SecureString
- [ ] Only `NEXT_PUBLIC_*` vars exposed to client
- [ ] Server-side code uses `import 'server-only'`
- [ ] Team knows not to commit credentials
- [ ] Credential rotation schedule established
- [ ] API key usage monitored

---

## üìö Additional Resources

### Git Security

- [GitHub Secret Scanning](https://docs.github.com/en/code-security/secret-scanning)
- [git-secrets](https://github.com/awslabs/git-secrets) - Prevent committing secrets
- [BFG Repo Cleaner](https://rtyley.github.io/bfg-repo-cleaner/) - Remove secrets from history

### AWS Security

- [SSM Parameter Store Best Practices](https://docs.aws.amazon.com/systems-manager/latest/userguide/parameter-store-best-practices.html)
- [IAM Best Practices](https://docs.aws.amazon.com/IAM/latest/UserGuide/best-practices.html)

### GHL Security

- [GHL API Security](https://highlevel.stoplight.io/)
- [GHL Help Center](https://help.gohighlevel.com/)

---

## üÜò Support

If you suspect a security issue:

1. **Immediately revoke compromised credentials**
2. **Notify the team**
3. **Follow the incident response plan**
4. **Update all affected systems**
5. **Review and improve security practices**

---

**Last Updated**: November 2024  
**Security Level**: Critical  
**Review Frequency**: Quarterly

