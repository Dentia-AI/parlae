name: Deploy Dev Environment

on:
  push:
    branches:
      - develop
  workflow_dispatch:

concurrency:
  group: dev-environment
  cancel-in-progress: false

jobs:
  deploy-dev:
    runs-on: ubuntu-latest
    env:
      AWS_REGION: us-east-2
      ENVIRONMENT: dev
      ECR_ACCOUNT: 509852961700.dkr.ecr.us-east-2.amazonaws.com
      FRONTEND_IMAGE: dentia-frontend
      BACKEND_IMAGE: dentia-backend
      INFRA_REPOSITORY: shaunk/dentia-infra
      INFRA_PATH: dentia-infra
    steps:
      - uses: actions/checkout@v4

      - name: Checkout infrastructure repository
        uses: actions/checkout@v4
        with:
          repository: ${{ env.INFRA_REPOSITORY }}
          token: ${{ secrets.INFRA_REPO_TOKEN || secrets.GITHUB_TOKEN }}
          path: ${{ env.INFRA_PATH }}

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::509852961700:role/GitHubActionsDentiaDevRole
          aws-region: ${{ env.AWS_REGION }}

      - uses: docker/setup-buildx-action@v3

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push frontend image (linux/amd64)
        run: |
          docker buildx build \
            --platform linux/amd64 \
            --build-arg NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY="${{ secrets.STRIPE_PUBLISHABLE_KEY_DEV }}" \
            --build-arg NEXT_PUBLIC_COGNITO_SOCIAL_PROVIDERS="Google" \
            -t ${ECR_ACCOUNT}/${FRONTEND_IMAGE}:dev \
            -f infra/docker/frontend.Dockerfile \
            --push \
            .

      - name: Build and push backend image (linux/amd64)
        run: |
          docker buildx build \
            --platform linux/amd64 \
            -t ${ECR_ACCOUNT}/${BACKEND_IMAGE}:dev \
            -f infra/docker/backend.Dockerfile \
            --push \
            .

      - name: Provision dev environment with Terraform
        working-directory: ${{ env.INFRA_PATH }}/infra/environments/dev
        env:
          TF_IN_AUTOMATION: 1
        run: |
          terraform init -backend-config=backend-prod.tf
          terraform workspace new ${ENVIRONMENT} || terraform workspace select ${ENVIRONMENT}
          terraform apply -auto-approve -var="environment=${ENVIRONMENT}" -var="frontend_image_tag=dev" -var="backend_image_tag=dev"

      - name: Post deployment summary
        run: |
          echo "âœ… Dev environment deployed"
          echo "Frontend: https://dev.parlae.ca"
